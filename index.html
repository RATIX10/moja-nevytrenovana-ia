<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>Moja Nevytrénovaná IA - Globálna Pamäť</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --bg: #0d1117; --accent: #58a6ff; --success: #238636; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        nav { background: #161b22; padding: 15px; display: flex; gap: 10px; border-bottom: 2px solid var(--accent); justify-content: center; }
        .nav-btn { background: #30363d; border: 1px solid var(--accent); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .nav-btn.active { background: var(--accent); }
        .main { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        #video-box { flex: 2; background: black; border-radius: 15px; position: relative; border: 2px solid #30363d; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); border-radius: 13px; }
        #sidebar { flex: 1; background: #161b22; border-radius: 15px; padding: 20px; overflow-y: auto; border: 1px solid #30363d; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .photo-grid img { width: 100%; border-radius: 4px; border: 1px solid #444; }
        #modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #161b22; padding: 25px; border-radius: 12px; border: 2px solid var(--accent); display: none; flex-direction: column; gap: 10px; z-index: 100; box-shadow: 0 0 50px black; }
        .res-text { font-size: 2.5em; color: #f1c40f; text-align: center; margin: 20px 0; font-weight: bold; }
        input { padding: 10px; background: #0d1117; color: white; border: 1px solid var(--accent); border-radius: 5px; }
    </style>
</head>
<body>

<nav>
    <button class="nav-btn active" onclick="setMode('test', this)">TESTOVANIE</button>
    <button class="nav-btn" onclick="setMode('train', this)">TRÉNOVANIE & CLOUD</button>
</nav>

<div class="main">
    <div id="video-box">
        <video autoplay playsinline muted id="webcam"></video>
        <div id="modal">
            <h3>Čo učíš túto AI?</h3>
            <input type="text" id="obj-name" placeholder="Názov objektu">
            <button onclick="uploadToCloud()" style="padding:10px; background:var(--success); color:white; border:none; cursor:pointer; font-weight:bold; border-radius:5px;">ULOŽIŤ PRE VŠETKÝCH</button>
            <button onclick="closeModal()" style="padding:5px; background:transparent; color:gray; border:none; cursor:pointer;">Zrušiť</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="ui-test" style="display:block">
            <h2>AI rozpoznáva:</h2>
            <div id="test-result" class="res-text">Načítavam...</div>
        </div>
        <div id="ui-train" style="display:none">
            <button onclick="takePhoto()" style="width:100%; padding:15px; background:var(--accent); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer">ODFOTIŤ NOVÝ OBJEKT</button>
            <h3 style="margin-top:20px">Spoločná pamäť:</h3>
            <input type="text" id="search" placeholder="Hľadať objekt v cloude..." oninput="refreshGallery()" style="width:100%; box-sizing:border-box">
            <div id="gallery" class="photo-grid"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBojtyniuMTYlTGCvWNrKt-jeGLGGa4Mh4",
        authDomain: "mojanevytrenovana-ia.firebaseapp.com",
        databaseURL: "https://mojanevytrenovana-ia-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mojanevytrenovana-ia",
        storageBucket: "mojanevytrenovana-ia.firebasestorage.app",
        messagingSenderId: "1032274868821",
        appId: "1:1032274868821:web:9ce396023dc4c15629b2dc"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let classifier = knnClassifier.create();
    let net;
    const video = document.getElementById('webcam');
    let allData = {};

    async function init() {
        document.getElementById('test-result').innerText = "Otváram oči...";
        net = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
        } catch (e) { alert("Chyba kamery!"); }

        database.ref('ai_memory').on('value', async (snapshot) => {
            const data = snapshot.val();
            if (data) {
                allData = data;
                await updateAIModel(data);
                refreshGallery();
                document.getElementById('test-result').innerText = "Hľadám...";
            } else {
                document.getElementById('test-result').innerText = "Pustá pamäť.";
            }
        });
        predict();
    }

    async function updateAIModel(data) {
        classifier.clearAllClasses();
        for (let label in data) {
            const photos = Object.values(data[label]);
            for (let imgBase64 of photos) {
                const img = new Image();
                img.src = imgBase64;
                await new Promise(r => img.onload = r);
                const tensor = tf.browser.fromPixels(img).resizeBilinear([224, 224]).expandDims(0).toFloat().div(127).sub(1);
                classifier.addExample(net.predict(tensor), label);
            }
        }
    }

    function takePhoto() {
        const canvas = document.createElement('canvas');
        canvas.width = 224; canvas.height = 224;
        canvas.getContext('2d').drawImage(video, 0, 0, 224, 224);
        window.currentSnap = canvas.toDataURL('image/jpeg', 0.6);
        video.pause();
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('obj-name').focus();
    }

    function uploadToCloud() {
        const name = document.getElementById('obj-name').value.trim().toLowerCase();
        if(!name) return alert("Musíš zadať meno!");
        database.ref('ai_memory/' + name).push(window.currentSnap);
        closeModal();
    }

    function refreshGallery() {
        const q = document.getElementById('search').value.toLowerCase();
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        if (q && allData[q]) {
            Object.values(allData[q]).forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                gallery.appendChild(img);
            });
        }
    }

    async function predict() {
        if(!video.paused && classifier.getNumClasses() > 0) {
            const img = await tf.browser.fromPixels(video);
            const processed = img.resizeBilinear([224, 224]).expandDims(0).toFloat().div(127).sub(1);
            const res = await classifier.predictClass(net.predict(processed));
            document.getElementById('test-result').innerText = res.confidences[res.label] > 0.55 ? res.label : "???";
            img.dispose(); processed.dispose();
        }
        requestAnimationFrame(predict);
    }

    function setMode(mode, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('ui-test').style.display = mode === 'test' ? 'block' : 'none';
        document.getElementById('ui-train').style.display = mode === 'train' ? 'block' : 'none';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('obj-name').value = "";
        video.play();
    }

    init();
</script>
</body>
</html>