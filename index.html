<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Glob치lna AI - Mobiln치 Verzia</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #0d1117; --accent: #58a6ff; --success: #238636; }
        body { margin: 0; background: var(--bg); color: white; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Navig치cia upraven치 pre mobil */
        nav { background: #161b22; padding: 10px; display: flex; gap: 8px; border-bottom: 2px solid var(--accent); justify-content: center; }
        .nav-btn { flex: 1; background: #30363d; border: 1px solid var(--accent); color: white; padding: 12px 5px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; }
        .nav-btn.active { background: var(--accent); }

        .main { display: flex; flex-direction: column; flex: 1; padding: 10px; gap: 10px; overflow-y: auto; }
        
        #video-box { width: 100%; aspect-ratio: 4/3; background: black; border-radius: 15px; position: relative; border: 2px solid #30363d; overflow: hidden; flex-shrink: 0; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); } /* Zrkadlenie len pre predn칰 kameru */

        #sidebar { background: #161b22; border-radius: 15px; padding: 15px; border: 1px solid #30363d; flex: 1; }
        
        .res-text { font-size: 2em; color: #f1c40f; text-align: center; margin: 15px 0; font-weight: bold; min-height: 1.2em; }
        
        /* Mobiln칠 ovl치danie kamery */
        .cam-controls { position: absolute; bottom: 10px; right: 10px; display: flex; gap: 10px; }
        .circle-btn { width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 1px solid white; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; }

        #modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #161b22; padding: 20px; border-radius: 12px; border: 2px solid var(--accent); display: none; flex-direction: column; gap: 15px; z-index: 1000; width: 85%; max-width: 300px; box-shadow: 0 0 100px black; }
        input { padding: 12px; background: #0d1117; color: white; border: 1px solid var(--accent); border-radius: 8px; font-size: 16px; }
        
        .btn-big { width: 100%; padding: 18px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 1.1em; color: white; }
        .photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        .photo-grid img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 4px; border: 1px solid #444; }

        @media (min-width: 768px) {
            .main { flex-direction: row; }
            #video-box { flex: 2; height: 100%; }
        }
    </style>
</head>
<body>

<nav>
    <button class="nav-btn active" onclick="setMode('test', this)">TESTOVANIE</button>
    <button class="nav-btn" onclick="setMode('train', this)">TR칄NOVANIE</button>
</nav>

<div class="main">
    <div id="video-box">
        <video autoplay playsinline muted id="webcam" class="mirror"></video>
        <div class="cam-controls">
            <div class="circle-btn" onclick="switchCamera()">游댃</div>
        </div>
        
        <div id="modal">
            <h3 style="margin:0">Ulo쬴콘 do cloudu</h3>
            <input type="text" id="obj-name" placeholder="N치zov objektu...">
            <button class="btn-big" style="background: var(--success);" onclick="uploadToCloud()">ULO콯I콗</button>
            <button onclick="closeModal()" style="background:transparent; color:gray; border:none; padding:5px;">Zru코i콘</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="ui-test">
            <h2 style="margin:0; font-size: 1.2em; text-align:center">AI Rozpozn치va:</h2>
            <div id="test-result" class="res-text">Na캜칤tavam...</div>
        </div>
        
        <div id="ui-train" style="display:none">
            <button class="btn-big" style="background: var(--accent);" onclick="takePhoto()">ODFOTI콗 OBJEKT</button>
            <input type="text" id="search" placeholder="H쬬da콘 v gal칠rii..." oninput="refreshGallery()" style="width:100%; margin-top:20px; box-sizing:border-box">
            <div id="gallery" class="photo-grid"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBojtyniuMTYlTGCvWNrKt-jeGLGGa4Mh4",
        authDomain: "mojanevytrenovana-ia.firebaseapp.com",
        databaseURL: "https://mojanevytrenovana-ia-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "mojanevytrenovana-ia",
        storageBucket: "mojanevytrenovana-ia.firebasestorage.app",
        messagingSenderId: "1032274868821",
        appId: "1:1032274868821:web:9ce396023dc4c15629b2dc"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    let classifier = knnClassifier.create();
    let net;
    let currentFacingMode = 'user'; // 'user' je predn치, 'environment' je zadn치
    const video = document.getElementById('webcam');
    let allData = {};

    async function setupWebcam() {
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: currentFacingMode },
            audio: false 
        });
        video.srcObject = stream;
        // Zrkadlenie len pre predn칰 kameru
        video.classList.toggle('mirror', currentFacingMode === 'user');
    }

    async function switchCamera() {
        currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
        await setupWebcam();
    }

    async function init() {
        document.getElementById('test-result').innerText = "Na캜칤tavam AI...";
        net = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
        
        await setupWebcam();

        database.ref('ai_memory').on('value', async (snapshot) => {
            const data = snapshot.val();
            if (data) {
                allData = data;
                await updateAIModel(data);
                refreshGallery();
                document.getElementById('test-result').innerText = "Pripraven칳";
            } else {
                document.getElementById('test-result').innerText = "Pr치zdna pam칛콘";
            }
        });
        predict();
    }

    async function updateAIModel(data) {
        classifier.clearAllClasses();
        for (let label in data) {
            for (let imgBase64 of Object.values(data[label])) {
                const img = new Image();
                img.src = imgBase64;
                await new Promise(r => img.onload = r);
                const tensor = tf.browser.fromPixels(img).resizeBilinear([224, 224]).expandDims(0).toFloat().div(127).sub(1);
                classifier.addExample(net.predict(tensor), label);
            }
        }
    }

    function takePhoto() {
        const canvas = document.createElement('canvas');
        canvas.width = 224; canvas.height = 224;
        const ctx = canvas.getContext('2d');
        // Ak je predn치 kamera, mus칤me zrkadli콘 aj fotku
        if(currentFacingMode === 'user') {
            ctx.translate(224, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(video, 0, 0, 224, 224);
        window.currentSnap = canvas.toDataURL('image/jpeg', 0.6);
        video.pause();
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('obj-name').focus();
    }

    function uploadToCloud() {
        const name = document.getElementById('obj-name').value.trim().toLowerCase();
        if(!name) return alert("Zadaj meno!");
        database.ref('ai_memory/' + name).push(window.currentSnap);
        closeModal();
    }

    function refreshGallery() {
        const q = document.getElementById('search').value.toLowerCase();
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        if (q && allData[q]) {
            Object.values(allData[q]).forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                gallery.appendChild(img);
            });
        }
    }

    async function predict() {
        if(!video.paused && classifier.getNumClasses() > 0) {
            const img = await tf.browser.fromPixels(video);
            const processed = img.resizeBilinear([224, 224]).expandDims(0).toFloat().div(127).sub(1);
            const res = await classifier.predictClass(net.predict(processed));
            document.getElementById('test-result').innerText = res.confidences[res.label] > 0.55 ? res.label : "???";
            img.dispose(); processed.dispose();
        }
        requestAnimationFrame(predict);
    }

    function setMode(mode, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('ui-test').style.display = mode === 'test' ? 'block' : 'none';
        document.getElementById('ui-train').style.display = mode === 'train' ? 'block' : 'none';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('obj-name').value = "";
        video.play();
    }

    init();
</script>
</body>
</html>