<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>AI Vision Trainer - Učenie a Testovanie</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { padding: 20px; text-align: center; background: #252525; border-bottom: 3px solid #4A90E2; }
        h1 { margin: 0; font-size: 2.2em; }
        .main-container { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        
        /* Video okno */
        #video-container { 
            flex: 2; position: relative; background: #000; border-radius: 15px; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
        }
        video { 
            width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); 
            border-radius: 15px; 
        }
        #webcam-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center; 
            background: rgba(0,0,0,0.5); /* Prekrytie počas otázok */
            opacity: 0; transition: opacity 0.3s ease; pointer-events: none;
            padding-bottom: 20px;
        }
        #webcam-overlay.active { opacity: 1; pointer-events: auto; }
        #overlay-text { font-size: 1.8em; margin-bottom: 15px; color: white; text-align: center; }
        #overlay-input { 
            background: rgba(255,255,255,0.9); border: none; padding: 15px 20px; 
            border-radius: 10px; font-size: 1.2em; width: 80%; max-width: 400px; 
        }
        #overlay-buttons { display: flex; gap: 15px; margin-top: 15px; }
        #overlay-buttons button { 
            padding: 12px 25px; border-radius: 8px; font-size: 1.1em; cursor: pointer; border: none;
            font-weight: bold; transition: background 0.2s ease;
        }
        #overlay-buttons .yes-btn { background: #2ecc71; color: white; }
        #overlay-buttons .yes-btn:hover { background: #27ae60; }
        #overlay-buttons .no-btn { background: #e74c3c; color: white; }
        #overlay-buttons .no-btn:hover { background: #c0392b; }

        /* Ovládací panel */
        #controls { 
            flex: 1; background: #2d2d2d; padding: 20px; border-radius: 15px; 
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; 
            max-height: calc(100vh - 120px); /* Prispôsobenie výšky */
        }
        h3 { color: #4A90E2; margin-top: 0; margin-bottom: 10px; font-size: 1.4em; }
        .control-group { margin-bottom: 20px; border-bottom: 1px solid #3a3a3a; padding-bottom: 20px; }
        .control-group:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }

        .class-btn, .action-btn { 
            padding: 15px; font-size: 1.1em; cursor: pointer; border: none; border-radius: 8px; 
            font-weight: bold; transition: 0.3s; width: 100%; margin-bottom: 10px; 
        }
        .class-btn { background: #555; color: white; }
        .class-btn.active { background: #4A90E2; }
        .class-btn:hover:not(.active) { background: #666; }

        .action-btn { background: #2ecc71; color: white; }
        .action-btn:hover { background: #27ae60; }
        .action-btn.red { background: #e74c3c; }
        .action-btn.red:hover { background: #c0392b; }
        
        #prediction-output { 
            font-size: 1.8em; text-align: center; color: #f1c40f; padding: 15px; 
            border: 2px dashed #f1c40f; border-radius: 10px; margin-top: 20px; 
            word-break: break-word; min-height: 80px; display: flex; align-items: center; justify-content: center;
        }
        
        .chat-input-area {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .chat-input-area input {
            flex-grow: 1; background: #3a3a3a; border: none; padding: 12px; 
            border-radius: 8px; color: white; font-size: 1.1em;
        }
        .chat-input-area button {
            background: #4A90E2; color: white; border: none; padding: 12px 20px; 
            border-radius: 8px; cursor: pointer; font-size: 1.1em;
        }
        .chat-input-area button:hover { background: #3A7CDA; }

        #output-image-area {
            margin-top: 20px; text-align: center;
            border-top: 1px solid #3a3a3a; padding-top: 20px;
        }
        #output-image-area img {
            max-width: 100%; max-height: 250px; border: 1px solid #4A90E2; border-radius: 10px;
        }
        #output-image-area p { margin-top: 10px; font-size: 1.1em; color: #f1c40f; }

        .status-bar { color: #888; font-size: 0.9em; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <h1>AI Vision: Učím sa nové veci!</h1>
    <div class="status-bar" id="status">Načítavam mozog AI a kameru...</div>
</header>

<div class="main-container">
    <div id="video-container">
        <video autoplay playsinline muted id="webcam"></video>
        <div id="webcam-overlay">
            <p id="overlay-text"></p>
            <input type="text" id="overlay-input" placeholder="Zadaj názov objektu">
            <div id="overlay-buttons">
                <button class="yes-btn" onclick="saveClassData()">Uložiť</button>
                <button class="no-btn" onclick="cancelTrainingStep()">Zrušiť</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="control-group">
            <h3>1. Nauč ma nové objekty</h3>
            <button class="action-btn" onclick="startLearningMode()">Spustiť učenie objektu</button>
            <p class="status-bar">Ukáž objekt, stlač "Spustiť učenie", drž tlačidlo pre učenie, zadaj názov.</p>
        </div>

        <div class="control-group">
            <h3>2. Testovanie a Konverzácia</h3>
            <div id="prediction-output">Čakám na učenie...</div>
            <div class="chat-input-area">
                <input type="text" id="chatInput" placeholder="Spýtaj sa ma niečo...">
                <button onclick="processChatCommand()">Odoslať</button>
            </div>
            <div id="output-image-area">
                <p id="image-output-label"></p>
                <img id="output-image" src="" alt="Generovaný obrázok" style="display:none;">
            </div>
        </div>

        <div class="control-group">
            <h3>3. Správa naučených objektov</h3>
            <div id="class-buttons">
                </div>
            <button class="action-btn red" onclick="clearAllData()">Vymazať všetko</button>
        </div>

        <div class="status-bar" id="processingStatus">Pripravený.</div>
    </div>
</div>

<script>
    const webcamElement = document.getElementById('webcam');
    const classifier = knnClassifier.create();
    let net; // Pre MobileNet
    let currentTrainingClassId = -1; // -1 = žiadny tréning, 0, 1, 2... = ID triedy
    let isLearningInProgress = false; // Kontrola či práve prebieha tréning
    let trainingImages = {}; // { classId: [ImageDataURL1, ImageDataURL2, ...] }
    let classNames = []; // { classId: "Názov objektu" }
    let exampleCount = 0; // Celkový počet príkladov pre classifier
    let currentScreenshot = null; // Aktuálny obrázok pre uloženie

    // Elementy pre prekrývacie okno
    const webcamOverlay = document.getElementById('webcam-overlay');
    const overlayText = document.getElementById('overlay-text');
    const overlayInput = document.getElementById('overlay-input');
    const overlayButtons = document.getElementById('overlay-buttons');

    // Inicializácia kamery a modelov
    async function setupWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            webcamElement.srcObject = stream;
            await new Promise((resolve) => {
                webcamElement.onloadeddata = () => resolve();
            });
            return true;
        } catch (error) {
            console.error("Chyba prístupu ku kamere:", error);
            document.getElementById('status').innerText = "Chyba: Nepodarilo sa získať prístup ku kamere.";
            return false;
        }
    }

    async function loadModels() {
        document.getElementById('status').innerText = "Načítavam MobileNet (oči AI)...";
        //net = await mobilenet.load(); // Používame @tensorflow-models/mobilenet
        net = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
        document.getElementById('status').innerText = "AI pripravená, čakám na kameru.";
    }

    async function app() {
        await loadModels();
        const webcamReady = await setupWebcam();

        if (!webcamReady) return;

        document.getElementById('status').innerText = "AI a kamera sú pripravené!";
        webcamElement.addEventListener('loadeddata', () => {
            webcamElement.play();
            // Spustenie nekonečnej slučky pre rozpoznávanie
            startPredictionLoop();
        }, false);
    }

    // Funkcia na získanie obrázku z kamery a jeho prípravu pre MobileNet
    async function getImage() {
        const img = await tf.browser.fromPixels(webcamElement);
        const centerHeight = img.shape[0] / 2;
        const beginHeight = centerHeight - (224 / 2);
        const centerWidth = img.shape[1] / 2;
        const beginWidth = centerWidth - (224 / 2);
        // Orezanie na 224x224 a normalizácia
        return img.slice([beginHeight, beginWidth, 0], [224, 224, 3]).expandDims(0).toFloat().div(tf.scalar(127)).sub(tf.scalar(1));
    }

    // --- UČENIE NOVÝCH OBJEKTOV ---

    // Spustí režim, kde sa čaká na tréning
    async function startLearningMode() {
        if (isLearningInProgress) return; // Zabráni opätovnému spusteniu
        isLearningInProgress = true;
        document.getElementById('processingStatus').innerText = "Pripravujem sa na učenie. Ukáž objekt a potom stlač a drž 'Trénovať'.";
        
        // Získanie obrázku pre screenshot
        const imgTensor = await getImage();
        // Konverzia na dátovú URL pre zobrazenie a uloženie
        currentScreenshot = await tf.browser.toPixels(imgTensor).then(async canvas => {
            return canvas.toDataURL('image/jpeg', 0.8);
        });
        imgTensor.dispose(); // Uvoľni pamäť

        // Zobrazenie overlayu s otázkou
        overlayText.innerText = "Čo je tento objekt?";
        overlayInput.value = "";
        webcamOverlay.classList.add('active');
        overlayInput.focus();
    }

    // Uloží dáta triedy po potvrdení používateľom
    async function saveClassData() {
        const className = overlayInput.value.trim();
        if (!className) {
            alert("Prosím, zadaj názov objektu!");
            return;
        }

        const newClassId = classNames.length; // Použijeme index ako ID
        classNames.push(className); // Pridáme názov triedy
        trainingImages[newClassId] = [currentScreenshot]; // Uložíme screenshot
        classifier.addExample(net.predict(await getImage()), newClassId); // Pridáme 1 príklad pre classifier

        document.getElementById('processingStatus').innerText = `Naučené: ${className}. Ukáž znovu ten istý objekt a stlač tlačidlo pre túto triedu (pod 'Správa naučených objektov'), aby si pridal ďalšie príklady pre presnejšie učenie.`;
        webcamOverlay.classList.remove('active');
        isLearningInProgress = false;
        currentScreenshot = null;
        updateClassButtons(); // Aktualizujeme tlačidlá s novou triedou
    }

    // Zruší krok učenia
    function cancelTrainingStep() {
        webcamOverlay.classList.remove('active');
        isLearningInProgress = false;
        currentScreenshot = null;
        document.getElementById('processingStatus').innerText = "Učenie zrušené. Pripravený.";
    }

    // Pridá príklad pre existujúcu triedu (držaním tlačidla)
    let isAddingExample = false;
    async function addExampleToClass(classId, buttonElement) {
        if (!net || !webcamElement) {
            document.getElementById('processingStatus').innerText = "Najprv počkaj, kým sa načítajú modely a kamera.";
            return;
        }
        
        buttonElement.classList.add('active');
        isAddingExample = true;
        document.getElementById('processingStatus').innerText = `Učím AI: ${classNames[classId]}. Drž tlačidlo a pohybuj objektom. Príkladov: ${classifier.getNumExamplesForClass(classId)}`;

        while (isAddingExample) {
            try {
                const img = await getImage();
                const activation = net.predict(img); // Získame vlastnosti z MobileNet
                classifier.addExample(activation, classId); // Pridáme príklad do KNN klasifikátora
                img.dispose(); // Uvoľníme pamäť tenzora
                document.getElementById('processingStatus').innerText = `Učím AI: ${classNames[classId]}. Príkladov: ${classifier.getNumExamplesForClass(classId)}`;
            } catch (error) {
                console.error("Chyba pri pridávaní príkladu:", error);
                document.getElementById('processingStatus').innerText = "Chyba pri učení. Skontroluj konzolu.";
                isAddingExample = false;
            }
            await tf.nextFrame();
        }
        buttonElement.classList.remove('active');
        document.getElementById('processingStatus').innerText = `Učenie pre ${classNames[classId]} dokončené. Celkovo príkladov: ${classifier.getNumExamplesForClass(classId)}`;
    }

    // Zastaví pridávanie príkladov (po pustení tlačidla)
    function stopAddingExample(buttonElement) {
        isAddingExample = false;
        buttonElement.classList.remove('active');
    }

    // --- TESTOVANIE A ROZPOZNÁVANIE ---

    async function startPredictionLoop() {
        while (true) {
            if (classifier.getNumClasses() > 0 && !isLearningInProgress && !isAddingExample) {
                try {
                    const img = await getImage();
                    const activation = net.predict(img);
                    const result = await classifier.predictClass(activation);
                    
                    if (result.confidences[result.label] > 0.7) { // Použijeme prah spoľahlivosti
                        document.getElementById('prediction-output').innerText = `Toto je: ${classNames[result.label]}`;
                        // Ak je to rozpoznaný objekt, skryjeme starý obrázok
                        document.getElementById('output-image').style.display = 'none';
                        document.getElementById('image-output-label').innerText = '';
                    } else {
                        document.getElementById('prediction-output').innerText = "Neviem, čo to je...";
                    }
                    img.dispose();
                } catch (error) {
                    // console.error("Chyba pri predikcii:", error);
                    document.getElementById('prediction-output').innerText = "Čakám na dáta na tréning...";
                }
            } else if (classifier.getNumClasses() === 0) {
                document.getElementById('prediction-output').innerText = "Nauč ma najprv nejaké objekty!";
            }
            await tf.nextFrame();
        }
    }

    // --- CHAT PRÍKAZY ---

    async function processChatCommand() {
        const command = document.getElementById('chatInput').value.trim().toLowerCase();
        document.getElementById('chatInput').value = ""; // Vyčisti input

        // Ukáž mi [názov objektu]
        if (command.startsWith("ukaz mi ")) {
            const objectName = command.substring(8).trim();
            const classId = classNames.findIndex(name => name.toLowerCase() === objectName);

            if (classId !== -1 && trainingImages[classId] && trainingImages[classId].length > 0) {
                const imgElement = document.getElementById('output-image');
                imgElement.src = trainingImages[classId][0]; // Zobraz prvý uložený obrázok
                imgElement.style.display = 'block';
                document.getElementById('image-output-label').innerText = `Tu je ${classNames[classId]} (čo si ma naučil).`;
            } else {
                document.getElementById('image-output-label').innerText = `Neviem ti ukázať "${objectName}". Buď ma to nenaučil, alebo nemám uložený obrázok.`;
                document.getElementById('output-image').style.display = 'none';
            }
        } else {
            document.getElementById('image-output-label').innerText = `Nerozumiem príkazu: "${command}". Skús "ukaz mi [názov]".`;
            document.getElementById('output-image').style.display = 'none';
        }
    }

    // --- SPRÁVA TRIED (OBJEKTOV) ---

    function updateClassButtons() {
        const classButtonsDiv = document.getElementById('class-buttons');
        classButtonsDiv.innerHTML = ""; // Vyčisti staré tlačidlá

        classNames.forEach((name, id) => {
            const button = document.createElement('button');
            button.classList.add('class-btn');
            button.innerText = `${name} (${classifier.getNumExamplesForClass(id)} príkladov)`;
            button.onmousedown = () => addExampleToClass(id, button);
            button.onmouseup = () => stopAddingExample(button);
            classButtonsDiv.appendChild(button);
        });
    }

    function clearAllData() {
        if (confirm("Naozaj chceš vymazať všetky naučené objekty a príklady?")) {
            classifier.clearAllClasses();
            classNames = [];
            trainingImages = {};
            currentTrainingClassId = -1;
            document.getElementById('prediction-output').innerText = "Všetky dáta vymazané. AI má prázdnu pamäť.";
            document.getElementById('output-image').style.display = 'none';
            document.getElementById('image-output-label').innerText = '';
            updateClassButtons();
        }
    }

    app();
</script>

</body>
</html>
