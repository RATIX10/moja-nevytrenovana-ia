<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <title>AI Vision - Opravené Vyhľadávanie</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
    <style>
        :root {
            --bg: #0d1117; --panel: #161b22; --accent: #58a6ff; --success: #238636;
        }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        
        nav { background: var(--panel); padding: 15px; display: flex; gap: 15px; border-bottom: 2px solid var(--accent); }
        .nav-btn { background: #30363d; border: 1px solid var(--accent); color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .nav-btn.active { background: var(--accent); }

        .main-content { display: flex; flex: 1; padding: 20px; gap: 20px; overflow: hidden; }
        
        #video-section { flex: 2; background: black; border-radius: 15px; position: relative; border: 2px solid #30363d; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); border-radius: 13px; }

        /* Vyskakovacie okno pri fotení */
        #train-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--panel); padding: 25px; border-radius: 12px; border: 2px solid var(--accent);
            display: none; flex-direction: column; gap: 15px; z-index: 100; width: 280px;
        }
        #train-modal input { padding: 10px; background: #0d1117; color: white; border: 1px solid #30363d; }

        #sidebar { flex: 1; background: var(--panel); border-radius: 15px; padding: 20px; border: 1px solid #30363d; overflow-y: auto; }
        .mode-ui { display: none; }
        .mode-ui.active { display: block; }

        .btn-action { width: 100%; padding: 15px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .btn-train { background: var(--success); color: white; }

        /* SEKCE VYHĽADÁVANIA */
        .search-box { background: #0d1117; padding: 15px; border-radius: 10px; border: 1px solid #30363d; margin-top: 20px; }
        .search-box input { width: 100%; padding: 12px; box-sizing: border-box; background: #161b22; color: white; border: 1px solid var(--accent); border-radius: 5px; font-size: 1.1em; }
        #gallery-preview { margin-top: 15px; text-align: center; }
        #gallery-preview img { max-width: 100%; border-radius: 8px; border: 2px solid var(--accent); display: none; }
        
        .result-text { font-size: 2em; color: #f1c40f; text-align: center; margin-top: 50px; font-weight: bold; }
        .list-info { color: #8b949e; font-size: 0.8em; margin-top: 10px; }
    </style>
</head>
<body>

<nav>
    <button class="nav-btn active" onclick="setMode('test', this)">TESTOVANIE</button>
    <button class="nav-btn" onclick="setMode('train', this)">TRÉNOVANIE</button>
</nav>

<div class="main-content">
    <div id="video-section">
        <video autoplay playsinline muted id="webcam"></video>
        <div id="train-modal">
            <h3>Názov objektu</h3>
            <input type="text" id="obj-name" placeholder="Napr. kniha">
            <button class="btn-action" style="background: var(--accent); color: white;" onclick="confirmSave()">ULOŽIŤ</button>
        </div>
    </div>

    <div id="sidebar">
        <div id="ui-test" class="mode-ui active">
            <h2>Hľadám objekty...</h2>
            <div id="test-result" class="result-text">---</div>
        </div>

        <div id="ui-train" class="mode-ui">
            <h2>Trénovanie</h2>
            <button class="btn-action btn-train" onclick="takePhoto()">ODFOTIŤ NOVÝ OBJEKT</button>
            
            <div class="search-box">
                <h3>Vyhľadať v pamäti</h3>
                <input type="text" id="search-input" placeholder="Zadaj názov (napr. mobil)" oninput="doSearch()">
                <div id="gallery-preview">
                    <img id="preview-img" src="">
                    <p id="preview-label" style="color: #58a6ff;"></p>
                </div>
                <div class="list-info" id="known-list">Zatiaľ nepoznám žiadne objekty.</div>
            </div>
        </div>
    </div>
</div>

<script>
    let classifier = knnClassifier.create();
    let net;
    let video = document.getElementById('webcam');
    let savedImages = {}; // Objekt pre fotky
    let tempSnap = null;
    let tempAct = null;

    async function start() {
        net = await tf.loadLayersModel('https://storage.googleapis.com/tfjs-models/tfjs/mobilenet_v1_0.25_224/model.json');
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        setInterval(predict, 250);
    }

    function setMode(mode, btn) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.mode-ui').forEach(ui => ui.classList.remove('active'));
        document.getElementById('ui-' + mode).classList.add('active');
    }

    async function takePhoto() {
        // Vytvorenie fotky (vizuálnej)
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        tempSnap = canvas.toDataURL('image/jpeg');

        video.pause();
        // Spracovanie pre AI
        const img = await tf.browser.fromPixels(video);
        const processed = img.resizeBilinear([224, 224]).expandDims(0).toFloat().div(127).sub(1);
        tempAct = net.predict(processed);

        document.getElementById('train-modal').style.display = 'flex';
        document.getElementById('obj-name').focus();
    }

    function confirmSave() {
        let name = document.getElementById('obj-name').value.trim().toLowerCase();
        if(!name) return;

        classifier.addExample(tempAct, name);
        savedImages[name] = tempSnap; // Uložíme fotku k názvu
        
        // Aktualizujeme zoznam názvov
        document.getElementById('known-list').innerText = "Poznám: " + Object.keys(savedImages).join(", ");
        
        document.getElementById('train-modal').style.display = 'none';
        document.getElementById('obj-name').value = "";
        video.play();
    }

    function doSearch() {
        let q = document.getElementById('search-input').value.trim().toLowerCase();
        let img = document.getElementById('preview-img');
        let label = document.getElementById('preview-label');

        if(q && savedImages[q]) {
            img.src = savedImages[q];
            img.style.display = 'block';
            label.innerText = "Fotka pre: " + q;
        } else {
            img.style.display = 'none';
            label.innerText = q ? "Nenájdené" : "";
        }
    }

    async function predict() {
        if(document.getElementById('ui-test').classList.contains('active') && classifier.getNumClasses() > 0 && !video.paused) {
            const img = await tf.browser.fromPixels(video);
            const processed = img.resizeBilinear([224, 224]).expandDims(0).toFloat().div(127).sub(1);
            const res = await classifier.predictClass(net.predict(processed));
            
            if(res.confidences[res.label] > 0.6) {
                document.getElementById('test-result').innerText = res.label;
            } else {
                document.getElementById('test-result').innerText = "???";
            }
            img.dispose(); processed.dispose();
        }
    }

    start();
</script>
</body>
</html>
